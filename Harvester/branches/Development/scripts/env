#!/bin/bash

#Mysql username, password, and server address for backups in scripts
#parse VIVO.xml for these values
#need to reconcile having 2 places for this

VIVOCONFIG='config/jenaModels/VIVO.xml'
SERVER=`grep dbUrl $VIVOCONFIG| sed 's|^.*://\([^:^\/]*\)[:\/].*$|\1|g'`
DBNAME=`grep dbUrl VIVO.xml | sed 's/^.*>.*\/\([^<]*\)<.*$/\1/`
USERNAME=`grep dbUser $VIVOCONFIG | sed 's|^.*>\([^<]*\)<.*$|\1|g'`
PASSWORD=`grep dbPass $VIVOCONFIG | sed 's|^.*>\([^<]*\)<.*$|\1|g'`
NAMESPACE=`grep namespace $VIVOCONFIG | sed 's|^.*>\([^<]*\)<.*$|\1|g'`
VERSION=1.0beta5
MIN_MEM=1024m
MAX_MEM=2048M
#Variable for optimizations to the Java virtual machine.
#-server				Run in server mode, which takes longer to start but runs faster
#-d64					Use 64-bit JVM
#-XX:+UseConcMarkSweepGC		Use concurrent (low pause time) garbage collector	
#-XX:+DisableExplicitGC			Prevent direct calls to garbage collection in the code
#-XX:+UseAdaptiveGCBoundary		Allow young/old boundary to move
#-XX:MaxGCPauseMillis=500		�Target� maximum for garbage collection time
#-XX:-UseGCOverheadLimit		Limit the amount of time that Java will stay in Garbage Collection before throwing an out of memory exception
#-XX:SurvivorRatio=16			Shrink eden slightly (Normal is 25)
#-Xnoclassgc				Disable collection of class objects
#-XX:UseSSE=3				Use SSE3 Processor extensions
#-XX:ParallelGCThreads=3		Maximum number of Parallel garbage collection tasks
#OPTS="-d64 -XX:+UseConcMarkSweepGC -XX:+DisableExplicitGC -XX:+UseAdaptiveGCBoundary -XX:MaxGCPauseMillis=500 -XX:-UseGCOverheadLimit -XX:SurvivorRatio=16 -Xnoclassgc -XX:UseSSE=3 -XX:ParallelGCThreads=3"
OPTS="-XX:+UseConcMarkSweepGC -XX:+DisableExplicitGC -XX:+UseAdaptiveGCBoundary -XX:MaxGCPauseMillis=500 -XX:-UseGCOverheadLimit -XX:SurvivorRatio=16 -Xnoclassgc -XX:UseSSE=3 -XX:ParallelGCThreads=3"
DATE=`date +%Y-%m-%d'T'%T`
HARVESTER_TASK="$HARVESTER_TASK.$DATE"
echo "Full Logging in $HARVESTER_TASK.log"

# Check for backups dir
if [ ! $NAMESPACE ]; then
  echo "Please specify namespace in $VIVOCONFIG file before running"
  exit
fi

# Check for backups dir
if [ ! -d backups ]; then
  mkdir backups
fi

# define shorthand aliases
Diff="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=Diff -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.diff.Diff"
D2RMapFetch="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=D2RMapFetch -Dprocess-task=D2RMapFetch -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.fetch.D2RMapFetch"
CSVMapFetch="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=CSVMapFetch -Dprocess-task=CSVMapFetch -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.fetch.CSVMapFetch"
JDBCFetch="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=JDBCFetch -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.fetch.JDBCFetch"
NIHFetch="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=NIHFetch -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.fetch.NIHFetch"
NLMJournalFetch="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=NLMJournalFetch -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.fetch.NLMJournalFetch"
OAIFetch="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=OAIFetch -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.fetch.OAIFetch"
PubmedFetch="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=PubmedFetch -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.fetch.PubmedFetch"
PubmedHTTPFetch="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=PubmedHTTPFetch -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.fetch.PubmedHTTPFetch"
Qualify="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=Qualify -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.qualify.Qualify"
Score="java -server $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=Score -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.score.Score"
Match="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=Match -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.score.Match"
Transfer="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=Transfer -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.transfer.Transfer"
GlozeTranslator="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=GlozeTranslator -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.translate.GlozeTranslator"
RDFTranslator="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=RDFTranslator -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.translate.RDFTranslator"
SPARQLTranslator="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=SPARQLTranslator -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.translate.SPARQLTranslator"
XSLTranslator="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=XSLTranslator -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.translate.XSLTranslator"
ChangeNamespace="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=ChangeNamespace -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.qualify.ChangeNamespace"
Update="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=Update -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.update.Update"
DatabaseClone="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=DatabaseClone -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.util.DatabaseClone"
Merge="java $OPTS -Xms$MIN_MEM -Xmx$MAX_MEM -Dharvester-task=$HARVESTER_TASK -Dprocess-task=Merge -cp bin/harvester-$VERSION.jar:bin/dependency/* org.vivoweb.harvester.util.Merge"